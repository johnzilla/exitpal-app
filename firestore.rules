rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Messages collection - users can only access their own messages
    match /messages/{messageId} {
      // Allow read and write only if the user is authenticated and owns the message
      allow read, write: if request.auth != null && 
                         request.auth.uid == resource.data.userId;
      
      // Allow create only if the user is authenticated and is creating their own message
      allow create: if request.auth != null && 
                    request.auth.uid == request.resource.data.userId &&
                    validateMessageData(request.resource.data);
    }
    
    // Helper function to validate message data structure
    function validateMessageData(data) {
      return data.keys().hasAll(['userId', 'contactName', 'messageContent', 'phoneNumber', 'scheduledTime', 'messageType', 'status']) &&
             data.userId is string &&
             data.contactName is string &&
             data.messageContent is string &&
             data.phoneNumber is string &&
             data.scheduledTime is timestamp &&
             data.messageType in ['sms', 'voice'] &&
             data.status in ['pending', 'sent', 'failed'];
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}