<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Vonage Integration</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #3b82f6;
            background: #f8fafc;
        }
        .error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .success {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .warning {
            background: #fef3c7;
            border-left-color: #f59e0b;
            color: #92400e;
        }
        .critical {
            background: #fecaca;
            border-left-color: #dc2626;
            color: #991b1b;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin: 5px 0;
        }
        .solution {
            background: #dbeafe;
            border-left-color: #3b82f6;
            padding: 20px;
            margin: 20px 0;
        }
        .checklist {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .checklist ul {
            margin: 0;
            padding-left: 20px;
        }
        .checklist li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® Vonage Message Rejection Debugger</h1>
        
        <div class="step critical">
            <h3>üéØ Issue Identified: Vonage Platform Rejection</h3>
            <p><strong>Error Code:</strong> Platform acceptance (SMS API) Failed -1</p>
            <p><strong>What this means:</strong> Vonage is rejecting your messages at the platform level, before they even reach the carrier.</p>
        </div>

        <div class="solution">
            <h3>üîß Most Likely Causes & Solutions</h3>
            
            <div class="checklist">
                <h4>1. üì± Phone Number Format Issues</h4>
                <ul>
                    <li><strong>Problem:</strong> Your phone number format might be incorrect</li>
                    <li><strong>Solution:</strong> Ensure phone number is in E.164 format: <code>+1234567890</code></li>
                    <li><strong>Check:</strong> No spaces, dashes, or parentheses</li>
                    <li><strong>Example:</strong> ‚úÖ <code>+13133009428</code> ‚ùå <code>313-300-9428</code></li>
                </ul>
            </div>

            <div class="checklist">
                <h4>2. üè¢ Vonage Account Configuration</h4>
                <ul>
                    <li><strong>Account Status:</strong> Check if your Vonage account is fully activated</li>
                    <li><strong>SMS Enabled:</strong> Verify SMS is enabled for your account</li>
                    <li><strong>Country Restrictions:</strong> Check if SMS is allowed to your country/region</li>
                    <li><strong>Balance:</strong> Ensure sufficient account balance</li>
                </ul>
            </div>

            <div class="checklist">
                <h4>3. üìû Sender Number Issues</h4>
                <ul>
                    <li><strong>Number Ownership:</strong> Verify you own/have rights to use <code>14792659352</code></li>
                    <li><strong>Number Type:</strong> Check if it's properly configured for SMS</li>
                    <li><strong>Compliance:</strong> Ensure number meets local regulations</li>
                </ul>
            </div>

            <div class="checklist">
                <h4>4. üîê API Credentials</h4>
                <ul>
                    <li><strong>API Key/Secret:</strong> Verify they're correct and active</li>
                    <li><strong>Permissions:</strong> Check if SMS permissions are enabled</li>
                    <li><strong>Rate Limits:</strong> Ensure you haven't exceeded API limits</li>
                </ul>
            </div>
        </div>

        <div class="step">
            <h3>Step 1: Test Phone Number Format</h3>
            <input type="tel" id="phone-test" placeholder="Enter your phone number" value="+13133009428">
            <button onclick="validatePhoneFormat()">Validate Format</button>
            <div id="phone-result"></div>
        </div>

        <div class="step">
            <h3>Step 2: Check Vonage Account Status</h3>
            <div class="checklist">
                <p><strong>Manual checks you need to do in your Vonage Dashboard:</strong></p>
                <ol>
                    <li>Go to <a href="https://dashboard.nexmo.com" target="_blank">Vonage Dashboard</a></li>
                    <li><strong>Check Account Status:</strong> Look for any warnings or restrictions</li>
                    <li><strong>Verify Balance:</strong> Ensure you have sufficient credit</li>
                    <li><strong>Check SMS Settings:</strong> Go to SMS ‚Üí Settings</li>
                    <li><strong>Verify Number:</strong> Check if <code>14792659352</code> is properly configured</li>
                    <li><strong>Review Compliance:</strong> Check for any compliance issues</li>
                </ol>
            </div>
            <button onclick="showAccountChecklist()">Show Detailed Account Checklist</button>
            <div id="account-result"></div>
        </div>

        <div class="step">
            <h3>Step 3: Test with Vonage's Test Numbers</h3>
            <p>Vonage provides test numbers that should always work. Let's try those first:</p>
            <button onclick="showTestNumbers()">Show Test Configuration</button>
            <div id="test-numbers"></div>
        </div>

        <div class="step">
            <h3>Step 4: Alternative Solutions</h3>
            <button onclick="showAlternatives()">Show Alternative Approaches</button>
            <div id="alternatives"></div>
        </div>

        <div class="step">
            <h3>Step 5: Contact Vonage Support</h3>
            <div class="checklist">
                <p>If the above doesn't work, contact Vonage support with this information:</p>
                <ul>
                    <li><strong>Error:</strong> Platform acceptance (SMS API) Failed -1</li>
                    <li><strong>API Key:</strong> [Your API Key]</li>
                    <li><strong>From Number:</strong> 14792659352</li>
                    <li><strong>To Number:</strong> +13133009428</li>
                    <li><strong>Message ID:</strong> 7efc10e7-d60a-42a3-b276-64c2f0ff7003</li>
                    <li><strong>Request:</strong> Please check why messages are being rejected at platform level</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'critical' ? 'critical' : '';
            element.innerHTML = `<div class="${className}"><pre>${message}</pre></div>`;
        }

        function validatePhoneFormat() {
            const phone = document.getElementById('phone-test').value.trim();
            
            if (!phone) {
                log('phone-result', '‚ùå Please enter a phone number', 'error');
                return;
            }

            const issues = [];
            const suggestions = [];

            // Check E.164 format
            if (!phone.startsWith('+')) {
                issues.push('Missing + prefix');
                suggestions.push('Add + at the beginning');
            }

            // Check for invalid characters
            const cleanPhone = phone.replace('+', '');
            if (!/^\d+$/.test(cleanPhone)) {
                issues.push('Contains non-digit characters');
                suggestions.push('Remove spaces, dashes, parentheses');
            }

            // Check length
            if (cleanPhone.length < 10 || cleanPhone.length > 15) {
                issues.push(`Invalid length: ${cleanPhone.length} digits`);
                suggestions.push('Should be 10-15 digits');
            }

            // Check US format specifically
            if (phone.startsWith('+1') && cleanPhone.length !== 11) {
                issues.push('US numbers should be 11 digits (1 + 10)');
                suggestions.push('Format: +1XXXXXXXXXX');
            }

            if (issues.length === 0) {
                log('phone-result', `‚úÖ Phone number format looks correct!
Format: ${phone}
Country: ${phone.startsWith('+1') ? 'US/Canada' : 'International'}
Length: ${cleanPhone.length} digits

This format should work with Vonage.`, 'success');
            } else {
                const corrected = phone.startsWith('+1') ? phone : '+1' + phone.replace(/\D/g, '');
                log('phone-result', `‚ùå Phone number format issues:
${issues.map(issue => '‚Ä¢ ' + issue).join('\n')}

Suggestions:
${suggestions.map(suggestion => '‚Ä¢ ' + suggestion).join('\n')}

Try this format: ${corrected}`, 'error');
            }
        }

        function showAccountChecklist() {
            log('account-result', `üìã Vonage Account Checklist

Go to https://dashboard.nexmo.com and check:

üîç ACCOUNT STATUS:
‚ñ° Account is fully verified and active
‚ñ° No warnings or restrictions displayed
‚ñ° Account type supports SMS (not just voice)

üí∞ BILLING & BALANCE:
‚ñ° Sufficient account balance (check top-right corner)
‚ñ° Payment method is valid and current
‚ñ° No billing issues or holds

üì± SMS CONFIGURATION:
‚ñ° SMS is enabled for your account
‚ñ° No country restrictions for US numbers
‚ñ° Rate limits not exceeded

üìû NUMBER CONFIGURATION:
‚ñ° Number 14792659352 is owned by your account
‚ñ° Number is configured for SMS (not just voice)
‚ñ° Number has proper SMS capabilities

üåç COMPLIANCE:
‚ñ° Account complies with local regulations
‚ñ° No spam or abuse flags
‚ñ° Proper opt-in procedures if required

üîê API SETTINGS:
‚ñ° API key and secret are correct
‚ñ° API has SMS permissions enabled
‚ñ° No IP restrictions blocking your requests

If ANY of these show issues, that's likely your problem!`, 'warning');
        }

        function showTestNumbers() {
            log('test-numbers', `üß™ Test with Vonage Test Configuration

1. Use Vonage's test credentials (if available):
   - Test API Key: (check Vonage docs)
   - Test numbers that always work

2. Try a different sender number:
   - Use a Vonage virtual number you definitely own
   - Or try without specifying 'from' (use default)

3. Test with a different recipient:
   - Try a different phone number
   - Use a landline vs mobile
   - Try an international number

4. Minimal test message:
   - Use simple text: "Test"
   - Avoid special characters
   - Keep it under 160 characters

5. Update your Edge Function to use test mode:

// Add this to your Edge Function for testing
const isTestMode = true;
const testFromNumber = isTestMode ? 'Vonage' : vonageNumber;

const smsBody = new URLSearchParams({
  api_key: vonageApiKey,
  api_secret: vonageApiSecret,
  from: testFromNumber, // Use 'Vonage' for testing
  to: to,
  text: content,
});`, 'warning');
        }

        function showAlternatives() {
            log('alternatives', `üîÑ Alternative Solutions

1. üì± USE DIFFERENT SENDER ID:
   Instead of a phone number, try:
   - from: "ExitPal" (alphanumeric sender)
   - from: "Vonage" (Vonage's default)
   - Don't specify 'from' at all

2. üåç TRY DIFFERENT REGIONS:
   - Test with international numbers
   - Use different country codes
   - Check regional restrictions

3. üîß SIMPLIFY THE REQUEST:
   Minimal working example:
   
   curl -X POST https://rest.nexmo.com/sms/json \\
     -d "api_key=YOUR_KEY" \\
     -d "api_secret=YOUR_SECRET" \\
     -d "to=13133009428" \\
     -d "text=Test"
   
   (Notice: no 'from' parameter)

4. üìû SWITCH TO VOICE CALLS:
   If SMS keeps failing, voice calls might work:
   - Voice API has different restrictions
   - Often more reliable for urgent messages
   - Can be more attention-grabbing

5. üîÑ USE DIFFERENT SMS PROVIDER:
   Consider switching to:
   - Twilio (very reliable)
   - AWS SNS
   - MessageBird
   - Plivo

6. üß™ TEST ENVIRONMENT:
   - Create a new Vonage account for testing
   - Use Vonage's sandbox/test environment
   - Verify with a known working setup`, 'warning');
        }

        // Auto-validate the phone number on load
        window.onload = function() {
            validatePhoneFormat();
        };
    </script>
</body>
</html>